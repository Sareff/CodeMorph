<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>UML Диаграмма на D3.js</title>
    <style>
        /* Стили для классов */
        .class-rect {
            fill: #f9f9f9;
            stroke: #000;
            stroke-width: 1px;
            cursor: move;
        }
        .class-text {
            font-family: Arial, sans-serif;
            font-size: 12px;
            pointer-events: none; /* Чтобы текст не мешал перетаскиванию */
        }
        .link {
            stroke: #000;
            stroke-width: 1.5px;
        }
        .inheritance-marker {
            fill: #fff;
            stroke: #000;
        }
        /* Стили для информации о классе */
        #class-info {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            display: none; /* Скрываем по умолчанию */
        }
        #close-info {
            background: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            float: right;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>UML Диаграмма на D3.js</h1>
    <!-- Контейнер для диаграммы -->
    <svg id="uml-diagram" width="100%" height="800"></svg>
    <!-- Контейнер для отображения информации о классе -->
    <div id="class-info">
        <button id="close-info">Закрыть</button>
        <div id="info-content"></div>
    </div>

    <!-- Подключаем D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Получаем данные из Flask
        var classesData = {{ classes_data | tojson }};
        
        var svg = d3.select("#uml-diagram");
        var width = +svg.attr("width");
        var height = +svg.attr("height");

        // Добавляем маркер для стрелки наследования
        svg.append('defs').append('marker')
            .attr('id', 'inheritance')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', 10)
            .attr('markerHeight', 10)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#000');

        // Создаём симуляцию D3
        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.name; }).distance(150))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(function(d) {
                return d.width ? d.width / 2 : 50;
            }));

        // Подготовка данных для связей
        var linksData = classesData.relationships.map(function(rel) {
            return {
                source: rel.from,
                target: rel.to,
                type: rel.type
            };
        });

        // Добавляем линии связей
        var link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(linksData)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr('marker-end', function(d) {
                if (d.type === 'inheritance') {
                    return 'url(#inheritance)';
                } else {
                    return '';
                }
            });

        // Добавляем группы для классов
        var node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(classesData.classes)
            .enter()
            .append("g")
            .attr("class", "class-node")
            .call(d3.drag()
                .on("start", dragStarted)
                .on("drag", dragged)
                .on("end", dragEnded)
            )
            .on("click", function(event, d) {
                showClassInfo(d.name);
            });

        // Добавляем прямоугольники
        node.append("rect")
            .attr("class", "class-rect")
            .attr("width", function(d) {
                var maxWidth = getMaxTextWidth(d);
                d.width = maxWidth + 20; // Добавляем отступы
                return d.width;
            })
            .attr("height", function(d) {
                var lineCount = getTotalLines(d);
                d.height = lineCount * 16 + 10; // 16px - высота строки
                return d.height;
            })
            .attr("rx", 5)
            .attr("ry", 5);

        // Добавляем текст
        node.each(function(d) {
            var y = 15;
            var group = d3.select(this);

            // Имя класса
            group.append("text")
                .attr("class", "class-text")
                .attr("x", 10)
                .attr("y", y)
                .text(d.name);

            y += 16;

            // Атрибуты
            if (d.attributes.length > 0) {
                group.append("text")
                    .attr("class", "class-text")
                    .attr("x", 10)
                    .attr("y", y)
                    .text('-----------------');
                y += 16;

                d.attributes.forEach(function(attr) {
                    group.append("text")
                        .attr("class", "class-text")
                        .attr("x", 10)
                        .attr("y", y)
                        .text(attr);
                    y += 16;
                });
            }

            // Методы
            if (d.methods.length > 0) {
                group.append("text")
                    .attr("class", "class-text")
                    .attr("x", 10)
                    .attr("y", y)
                    .text('-----------------');
                y += 16;

                d.methods.forEach(function(method) {
                    group.append("text")
                        .attr("class", "class-text")
                        .attr("x", 10)
                        .attr("y", y)
                        .text(method);
                    y += 16;
                });
            }
        });

        // Обновляем симуляцию
        simulation
            .nodes(classesData.classes)
            .on("tick", ticked);

        simulation.force("link")
            .links(linksData);

        function ticked() {
            link
                .attr("x1", function(d) { return d.source.x + d.source.width / 2; })
                .attr("y1", function(d) { return d.source.y + d.source.height / 2; })
                .attr("x2", function(d) { return d.target.x + d.target.width / 2; })
                .attr("y2", function(d) { return d.target.y + d.target.height / 2; });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            // Оставляем узел на месте после перетаскивания
            d.fx = d.x;
            d.fy = d.y;
        }

        // Функции для получения максимальной ширины текста и общего количества строк
        function getMaxTextWidth(d) {
            var texts = [d.name];
            if (d.attributes.length > 0) {
                texts.push('-----------------');
                texts = texts.concat(d.attributes);
            }
            if (d.methods.length > 0) {
                texts.push('-----------------');
                texts = texts.concat(d.methods);
            }
            var maxWidth = 0;
            var tempText = svg.append("text").attr("class", "class-text");

            texts.forEach(function(text) {
                tempText.text(text);
                var width = tempText.node().getBBox().width;
                if (width > maxWidth) maxWidth = width;
            });

            tempText.remove();
            return maxWidth;
        }

        function getTotalLines(d) {
            var count = 1; // Имя класса
            if (d.attributes.length > 0) {
                count += 1 + d.attributes.length;
            }
            if (d.methods.length > 0) {
                count += 1 + d.methods.length;
            }
            return count;
        }

        // Добавляем интерактивность для отображения информации о классе
        function showClassInfo(className) {
            var infoDiv = document.getElementById('class-info');
            var infoContent = document.getElementById('info-content');
            var classData = classesData.classes.find(cls => cls.name === className);
            if (classData) {
                infoContent.innerHTML = `<h3>${classData.name}</h3><p>${classData.info}</p>`;
                infoDiv.style.display = 'block';
            }
        }

        // Обработчик закрытия информации о классе
        document.getElementById('close-info').addEventListener('click', function() {
            document.getElementById('class-info').style.display = 'none';
        });
    </script>
</body>
</html>
